/************************************************************
 * Discrete Summation Formula Oscillator v2.1 (2024-07-15)
 * 
 * https://github.com/rabbiabe/dsf-oscillator-pico
 * 
 * Digital audio synthesis oscillator based on James A. 
 * Moorer's 1975 paper "The Synthesis of Complex Audio Spectra 
 * by Means of Discrete Summation Formulae;" coded for Raspberry 
 * Pi Pico. 
 * 
 * Article: https://ccrma.stanford.edu/files/papers/stanm5.pdf
 * 
 * For analysis of this synthesis method see Prof. Aaron 
 * Lanterman's video, which first brought this concept to my 
 * attention: https://www.youtube.com/watch?v=IoAc2241gx8
 ************************************************************/

#pragma once

/*
 * C++ HEADERS
 */
#include <cstdlib>
#include <cstdint>
#include <cstdio>

/*
 * PICO HEADERS
 */
#include "pico/stdlib.h"

/*
 * PROJECT HEADERS
 */
#include "inc/fix15.h"

/*
 * MATH CONSTANTS
 */
#define two32 4294967296.0

constexpr fix15 one15 = int2fix15(1),
                two15 = int2fix15(2),
                param_a_max15 = divfix15(int2fix15(900), int2fix15(1000)),
                param_a_min15 = divfix15(int2fix15(100), int2fix15(1000)),
                param_a_range = param_a_max15 - param_a_min15;

/*!
    @brief Discrete Summation Formula Oscillator class.

    Implements a frequency-synthesis algorithm described in James A. Moorer's 1975 paper "The Synthesis of Complex Audio Spectra 
    by Means of Discrete Summation Formulae" (https://ccrma.stanford.edu/files/papers/stanm5.pdf). For analysis of this synthesis 
    method see Prof. Aaron Lanterman's video: https://www.youtube.com/watch?v=IoAc2241gx8    
*/
class DsfOsc {

    public:
        DsfOsc(uint16_t sample_rate, uint8_t dac_bit_depth);
        uint16_t getNextSample(fix15 param_a);
        void freqs(fix15 freqNote, fix15 freqMod, bool reset = true);
        void freqs(fix15 freqMod, bool reset = false);
        
    private:
        void resetCount();
        
        static constexpr float table_sine_f[256] = { 0,0.02456902563,0.04912321825,0.07364775379,0.09812782612,0.1225486559,0.1468954996,0.1711536584,0.1953084869,0.2193454022,0.2432498925,0.2670075259,0.2906039594,0.3140249472,0.3372563492,0.3602841401,0.3830944173,0.4056734096,0.4280074854,0.4500831611,0.471887109,0.4934061653,0.5146273384,0.5355378165,0.5561249754,0.5763763859,0.5962798218,0.6158232668,0.634994922,0.6537832129,0.6721767964,0.6901645679,0.7077356676,0.7248794874,0.741585677,0.7578441505,0.7736450922,0.7889789625,0.803836504,0.8182087468,0.832087014,0.8454629268,0.8583284099,0.8706756959,0.8824973305,0.8937861767,0.904535419,0.9147385677,0.9243894631,0.9334822786,0.9420115245,0.9499720515,0.9573590537,0.9641680713,0.9703949935,0.9760360609,0.9810878679,0.9855473645,0.9894118585,0.9926790166,0.9953468665,0.9974137975,0.9988785617,0.9997402748,0.9999984166,0.9996528312,0.9987037272,0.9971516777,0.9949976197,0.9922428536,0.9888890425,0.9849382114,0.9803927453,0.9752553885,0.9695292426,0.9632177646,0.9563247649,0.948854405,0.9408111951,0.9321999909,0.9230259914,0.9132947351,0.9030120971,0.8921842853,0.8808178367,0.8689196136,0.8564967993,0.8435568937,0.8301077091,0.8161573651,0.801714284,0.7867871854,0.7713850812,0.7555172701,0.739193332,0.7224231221,0.705216765,0.6875846487,0.6695374182,0.6510859691,0.6322414411,0.6130152111,0.5934188866,0.5734642984,0.5531634937,0.5325287286,0.511572461,0.4903073426,0.4687462119,0.446902086,0.4247881526,0.4024177627,0.3798044219,0.3569617824,0.3339036351,0.3106439008,0.287196622,0.2635759545,0.2397961588,0.2158715913,0.1918166962,0.1676459959,0.143374083,0.1190156111,0.09458528618,0.07009785744,0.04556810865,0.02101084911,-0.003559095274,-0.02812689093,-0.05267770559,-0.07719671724,-0.1016691231,-0.1260801484,-0.1504150555,-0.1746591529,-0.1987978036,-0.2228164345,-0.2467005449,-0.2704357151,-0.2940076158,-0.3174020157,-0.3406047912,-0.3636019339,-0.3863795599,-0.4089239177,-0.4312213966,-0.453258535,-0.4750220285,-0.4964987379,-0.5176756969,-0.5385401206,-0.5590794125,-0.5792811723,-0.5991332039,-0.6186235218,-0.6377403594,-0.6564721751,-0.6748076601,-0.6927357447,-0.7102456053,-0.7273266706,-0.7439686283,-0.7601614312,-0.7758953033,-0.7911607455,-0.8059485417,-0.8202497642,-0.8340557787,-0.8473582503,-0.8601491479,-0.8724207492,-0.8841656456,-0.8953767463,-0.9060472829,-0.9161708132,-0.9257412254,-0.9347527416,-0.9431999212,-0.9510776645,-0.9583812155,-0.9651061647,-0.9712484522,-0.9768043697,-0.9817705629,-0.9861440335,-0.9899221413,-0.9931026052,-0.9956835051,-0.9976632829,-0.9990407432,-0.9998150546,-0.9999857494,-0.9995527247,-0.998516242,-0.9968769268,-0.994635769,-0.9917941216,-0.9883537002,-0.9843165818,-0.9796852038,-0.9744623623,-0.9686512104,-0.9622552566,-0.9552783621,-0.9477247392,-0.9395989483,-0.930905895,-0.9216508276,-0.9118393337,-0.9014773367,-0.8905710924,-0.8791271854,-0.8671525245,-0.8546543392,-0.8416401751,-0.8281178891,-0.814095645,-0.7995819084,-0.7845854418,-0.7691152989,-0.7531808194,-0.7367916234,-0.7199576056,-0.7026889292,-0.6849960196,-0.6668895587,-0.6483804778,-0.6294799514,-0.6101993902,-0.5905504344,-0.5705449467,-0.550195005,-0.5295128951,-0.5085111034,-0.4872023091,-0.4655993772,-0.4437153498,-0.4215634389,-0.3991570183,-0.3765096154,-0.3536349031,-0.3305466914,-0.3072589194,-0.2837856465,-0.2601410442,-0.2363393875,-0.212395046,-0.1883224757,-0.1641362098,-0.1398508502,-0.1154810587,-0.09104154811,-0.06654707314,-0.04201242183,-0.01745240644 };
        static constexpr float table_cosine_f[256] = { 1,0.9996981359,0.998792726,0.9972843167,0.9951738189,0.9924625066,0.9891520167,0.985244348,0.9807418595,0.9756472695,0.9699636539,0.9636944438,0.9568434244,0.9494147316,0.9414128504,0.9328426118,0.9237091899,0.9140180987,0.9037751891,0.8929866449,0.8816589796,0.869799032,0.8574139622,0.8445112475,0.8310986775,0.8171843499,0.8027766651,0.7878843215,0.7725163099,0.7566819084,0.7403906768,0.7236524506,0.7064773349,0.6888756991,0.6708581695,0.652435624,0.6336191848,0.6144202118,0.5948502961,0.5749212525,0.5546451128,0.5340341182,0.5131007121,0.4918575328,0.4703174052,0.4484933337,0.4263984942,0.4040462259,0.3814500236,0.3586235291,0.3355805235,0.3123349185,0.2889007481,0.2652921603,0.241523408,0.2176088413,0.193562898,0.1694000954,0.1451350211,0.1207823248,0.09635670872,0.07187291942,0.04734573842,0.02278997345,-0.001779550455,-0.026348,-0.05090054251,-0.07542235494,-0.09989863277,-0.124314599,-0.148655513,-0.1729066794,-0.1970534573,-0.2210812684,-0.2449756066,-0.268722046,-0.2923062504,-0.3157139813,-0.3389311068,-0.3619436101,-0.3847375978,-0.4072993086,-0.4296151213,-0.4516715633,-0.4734553184,-0.4949532353,-0.5161523349,-0.5370398189,-0.5576030768,-0.5778296941,-0.5977074593,-0.6172243716,-0.6363686483,-0.6551287313,-0.6734932947,-0.6914512511,-0.7089917591,-0.7261042287,-0.7427783288,-0.7590039927,-0.7747714245,-0.790071105,-0.8048937974,-0.8192305527,-0.8330727154,-0.8464119288,-0.8592401394,-0.8715496026,-0.8833328867,-0.894582878,-0.9052927844,-0.91545614,-0.925066809,-0.9341189891,-0.9426072154,-0.9505263631,-0.9578716513,-0.9646386454,-0.97082326,-0.9764217614,-0.9814307694,-0.98584726,-0.9896685669,-0.992892383,-0.9955167621,-0.9975401197,-0.9989612342,-0.9997792477,-0.9999936664,-0.9996043607,-0.9986115658,-0.9970158809,-0.9948182695,-0.9920200584,-0.9886229368,-0.9846289557,-0.9800405263,-0.974860419,-0.969091761,-0.962738035,-0.9558030769,-0.9482910737,-0.9402065604,-0.931554418,-0.9223398699,-0.9125684794,-0.9022461455,-0.8913791003,-0.8799739044,-0.8680374435,-0.855576924,-0.8425998686,-0.8291141119,-0.8151277957,-0.800649364,-0.7856875576,-0.7702514096,-0.7543502392,-0.7379936462,-0.7211915058,-0.7039539617,-0.6862914208,-0.6682145465,-0.6497342522,-0.6308616951,-0.6116082691,-0.5919855979,-0.5720055283,-0.5516801229,-0.5310216527,-0.5100425898,-0.4887555998,-0.4671735343,-0.445309423,-0.4231764658,-0.4007880251,-0.3781576174,-0.3552989053,-0.3322256893,-0.3089518993,-0.2854915863,-0.261858914,-0.2380681501,-0.2141336577,-0.1900698869,-0.1658913655,-0.1416126908,-0.1172485206,-0.09281356411,-0.06832257347,-0.04379033458,-0.01923165822,0.005338628823,0.02990569279,0.05445470185,0.07897083507,0.1034392914,0.1278452985,0.1521741218,0.1764110733,0.2005415204,0.224550895,0.2484247019,0.2721485278,0.29570805,0.319089045,0.3422773969,0.3652591063,0.3880202984,0.4105472319,0.4328263064,0.4548440714,0.4765872344,0.4980426681,0.5191974195,0.5400387169,0.5605539776,0.5807308161,0.6005570511,0.620020713,0.6391100508,0.6578135399,0.6761198885,0.6940180445,0.7114972022,0.7285468091,0.7451565718,0.7613164624,0.7770167249,0.7922478806,0.8070007338,0.8212663781,0.8350362007,0.8483018884,0.8610554325,0.8732891331,0.8849956045,0.8961677792,0.9067989121,0.916882585,0.9264127101,0.9353835338,0.9437896401,0.9516259541,0.9588877447,0.9655706277,0.9716705686,0.9771838847,0.9821072473,0.9864376841,0.9901725808,0.9933096824,0.9958470949,0.9977832866,0.9991170884,0.9998476952 };
        fix15 fn, fm, halfDac, table_sine[256], table_cosine[256];
        uint32_t stepNote, stepMod, countNote = 0, countMod = 0;
        uint16_t fs, dacbits;
};
